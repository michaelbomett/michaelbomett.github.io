

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>sales.views &mdash; Techfactura 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Techfactura
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">mobile_app</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Techfactura</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>sales.views</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sales.views</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.mixins</span> <span class="k">import</span> <span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="k">import</span> <span class="n">messages</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="k">import</span> <span class="n">ListView</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">,</span> <span class="n">CreateView</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">,</span> <span class="n">DeleteView</span><span class="p">,</span> <span class="n">TemplateView</span><span class="p">,</span> <span class="n">FormView</span><span class="p">,</span> <span class="n">View</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">Settings</span><span class="p">,</span> <span class="n">Payments</span><span class="p">,</span> <span class="n">InvoiceNew</span><span class="p">,</span> <span class="n">InvoiceNewTotal</span><span class="p">,</span> <span class="n">InssCompanyRecords</span><span class="p">,</span> <span class="n">InssRecords</span><span class="p">,</span> <span class="n">Profile</span>
<span class="kn">from</span> <span class="nn">company.models</span> <span class="k">import</span> <span class="n">CompProfile</span><span class="p">,</span> <span class="n">SubCategory</span><span class="p">,</span> <span class="n">CategoryBase</span><span class="p">,</span> <span class="n">Pricing</span><span class="p">,</span> <span class="n">ImageList</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">transaction</span><span class="p">,</span> <span class="n">IntegrityError</span>
<span class="kn">from</span> <span class="nn">sales.templates.sales.forms</span> <span class="k">import</span> <span class="n">CompanyForm</span><span class="p">,</span> <span class="n">ProductForm</span><span class="p">,</span> <span class="n">PaymentForm</span><span class="p">,</span> <span class="n">CustomProductForm</span><span class="p">,</span> <span class="n">InssForm</span><span class="p">,</span> \
    <span class="n">InssCompanyForm</span><span class="p">,</span> <span class="n">SettleForm</span><span class="p">,</span> <span class="n">CompanyChoiceForm</span><span class="p">,</span> <span class="n">ConfirmPasswordForm</span><span class="p">,</span> <span class="n">MZForm</span><span class="p">,</span> <span class="n">KEForm</span><span class="p">,</span> <span class="n">AOForm</span><span class="p">,</span> <span class="n">UserProductForm</span><span class="p">,</span> <span class="n">DeliveryForm</span><span class="p">,</span> <span class="n">ImageForm</span><span class="p">,</span> <span class="n">BuyNowForm</span>
<span class="kn">from</span> <span class="nn">.filters</span> <span class="k">import</span> <span class="n">CompanyStatementFilter</span><span class="p">,</span> <span class="n">UserStatementFilter</span><span class="p">,</span> <span class="n">InvoiceCompanyFilter</span><span class="p">,</span> <span class="n">InvoiceUserFilter</span><span class="p">,</span> <span class="n">ISPCFilter</span><span class="p">,</span> <span class="n">ProductFilter</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="k">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="k">import</span> <span class="n">APIView</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="k">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="k">import</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="k">import</span> <span class="n">InvoiceTotalsSerializer</span><span class="p">,</span> <span class="n">InvoiceSerializer</span><span class="p">,</span> <span class="n">SettingsSerializer</span><span class="p">,</span> <span class="n">PaymentsSerializer</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="k">import</span> <span class="n">generics</span><span class="p">,</span> <span class="n">mixins</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">Sum</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">twilio.rest</span> <span class="k">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="k">import</span> <span class="n">gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="k">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">sales.templates.sales.decorators</span> <span class="k">import</span> <span class="n">confirm_password</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">sales/views.py</span>
<span class="sd">====================================</span>
<span class="sd">The core module of my project</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="c1">#discontinued</span>
<div class="viewcode-block" id="InvoiceTotalsAPIView"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceTotalsAPIView">[docs]</a><span class="k">class</span> <span class="nc">InvoiceTotalsAPIView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<div class="viewcode-block" id="InvoiceTotalsAPIView.get"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceTotalsAPIView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">invoicetotals</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">InvoiceTotalsSerializer</span><span class="p">(</span><span class="n">invoicetotals</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="InvoiceTotalsAPIView.post"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceTotalsAPIView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">InvoiceTotalsSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="InvoiceTotalsDetailView"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceTotalsDetailView">[docs]</a><span class="k">class</span> <span class="nc">InvoiceTotalsDetailView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<div class="viewcode-block" id="InvoiceTotalsDetailView.get_object"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceTotalsDetailView.get_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">DoesNotExist</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span><span class="s2">&quot;Given Invoice Does Not Exist&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span></div>

<div class="viewcode-block" id="InvoiceTotalsDetailView.get"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceTotalsDetailView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">serializer</span><span class="o">=</span><span class="n">InvoiceTotalsSerializer</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="InvoiceTotalsDetailView.put"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceTotalsDetailView.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span>
        <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">serializer</span><span class="o">=</span><span class="n">InvoiceTotalsSerializer</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span></div>

<div class="viewcode-block" id="InvoiceTotalsDetailView.delete"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceTotalsDetailView.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">204</span><span class="p">)</span></div></div>


<span class="c1">#API inuse class#####################################################################333</span>

<div class="viewcode-block" id="InvoiceTotalsAPIListView"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceTotalsAPIListView">[docs]</a><span class="k">class</span> <span class="nc">InvoiceTotalsAPIListView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">GenericAPIView</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">ListModelMixin</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">UpdateModelMixin</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">CreateModelMixin</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">RetrieveModelMixin</span><span class="p">):</span>

    <span class="n">queryset</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">InvoiceTotalsSerializer</span>
    <span class="n">lookup_field</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>

<div class="viewcode-block" id="InvoiceTotalsAPIListView.get"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceTotalsAPIListView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>

<div class="viewcode-block" id="InvoiceTotalsAPIListView.post"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceTotalsAPIListView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>

<div class="viewcode-block" id="InvoiceTotalsAPIListView.put"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceTotalsAPIListView.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="InvoiceAPIListView"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceAPIListView">[docs]</a><span class="k">class</span> <span class="nc">InvoiceAPIListView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">GenericAPIView</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">ListModelMixin</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">UpdateModelMixin</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">CreateModelMixin</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">RetrieveModelMixin</span><span class="p">):</span>

    <span class="n">queryset</span> <span class="o">=</span> <span class="n">InvoiceNew</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">InvoiceSerializer</span>
    <span class="n">lookup_field</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>

<div class="viewcode-block" id="InvoiceAPIListView.get"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceAPIListView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>

<div class="viewcode-block" id="InvoiceAPIListView.post"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceAPIListView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>

<div class="viewcode-block" id="InvoiceAPIListView.put"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceAPIListView.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SettingsAPIListView"><a class="viewcode-back" href="../../sales.html#sales.views.SettingsAPIListView">[docs]</a><span class="k">class</span> <span class="nc">SettingsAPIListView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">GenericAPIView</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">ListModelMixin</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">UpdateModelMixin</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">CreateModelMixin</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">RetrieveModelMixin</span><span class="p">):</span>

    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">SettingsSerializer</span>
    <span class="n">lookup_field</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>

<div class="viewcode-block" id="SettingsAPIListView.get"><a class="viewcode-back" href="../../sales.html#sales.views.SettingsAPIListView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>

<div class="viewcode-block" id="SettingsAPIListView.post"><a class="viewcode-back" href="../../sales.html#sales.views.SettingsAPIListView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>

<div class="viewcode-block" id="SettingsAPIListView.put"><a class="viewcode-back" href="../../sales.html#sales.views.SettingsAPIListView.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PaymentsAPIListView"><a class="viewcode-back" href="../../sales.html#sales.views.PaymentsAPIListView">[docs]</a><span class="k">class</span> <span class="nc">PaymentsAPIListView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">GenericAPIView</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">ListModelMixin</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">UpdateModelMixin</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">CreateModelMixin</span><span class="p">,</span>
                            <span class="n">mixins</span><span class="o">.</span><span class="n">RetrieveModelMixin</span><span class="p">):</span>

    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Payments</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PaymentsSerializer</span>
    <span class="n">lookup_field</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>

<div class="viewcode-block" id="PaymentsAPIListView.get"><a class="viewcode-back" href="../../sales.html#sales.views.PaymentsAPIListView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>

<div class="viewcode-block" id="PaymentsAPIListView.post"><a class="viewcode-back" href="../../sales.html#sales.views.PaymentsAPIListView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>

<div class="viewcode-block" id="PaymentsAPIListView.put"><a class="viewcode-back" href="../../sales.html#sales.views.PaymentsAPIListView.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span></div></div>


<span class="c1">#########################  API ends here ###################################################</span>

<div class="viewcode-block" id="sales_home"><a class="viewcode-back" href="../../sales.html#sales.views.sales_home">[docs]</a><span class="nd">@login_required</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">sales_home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">time_threshold</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">payments</span> <span class="o">=</span> <span class="n">Payments</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">seller</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="p">,</span> <span class="n">payment_date__gt</span><span class="o">=</span><span class="n">time_threshold</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">payments</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Transactions&#39;</span><span class="p">),</span> <span class="s1">&#39;payments&#39;</span><span class="p">:</span> <span class="n">payments</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;sales/home.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="SettingsDetailView"><a class="viewcode-back" href="../../sales.html#sales.views.SettingsDetailView">[docs]</a><span class="k">class</span> <span class="nc">SettingsDetailView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Settings</span>

<div class="viewcode-block" id="SettingsDetailView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.SettingsDetailView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">owner_settings</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="SettingsCreateView"><a class="viewcode-back" href="../../sales.html#sales.views.SettingsCreateView">[docs]</a><span class="k">class</span> <span class="nc">SettingsCreateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/settings_form.html&#39;</span>

<div class="viewcode-block" id="SettingsCreateView.get"><a class="viewcode-back" href="../../sales.html#sales.views.SettingsCreateView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="s1">&#39;mozambique&#39;</span><span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">MZForm</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="s1">&#39;kenya&#39;</span><span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">KEForm</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="s1">&#39;angola&#39;</span><span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">AOForm</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">MZForm</span><span class="p">()</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Setup your Profile&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;profile-home&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="SettingsCreateView.post"><a class="viewcode-back" href="../../sales.html#sales.views.SettingsCreateView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span> <span class="o">==</span> <span class="s1">&#39;mozambique&#39;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">MZForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="s1">&#39;kenya&#39;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">KEForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="s1">&#39;angola&#39;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">AOForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">MZForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">owner_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;settings-detail&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SettingsUpdateView"><a class="viewcode-back" href="../../sales.html#sales.views.SettingsUpdateView">[docs]</a><span class="k">class</span> <span class="nc">SettingsUpdateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">View</span><span class="p">):</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/settings_form.html&#39;</span>

<div class="viewcode-block" id="SettingsUpdateView.get"><a class="viewcode-back" href="../../sales.html#sales.views.SettingsUpdateView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">setting</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Settings</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="s1">&#39;mozambique&#39;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">MZForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">setting</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="s1">&#39;kenya&#39;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">KEForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">setting</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="s1">&#39;angola&#39;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">AOForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">setting</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">MZForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">setting</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="SettingsUpdateView.post"><a class="viewcode-back" href="../../sales.html#sales.views.SettingsUpdateView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">setting</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Settings</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span> <span class="o">==</span> <span class="s1">&#39;mozambique&#39;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">MZForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">setting</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="s1">&#39;kenya&#39;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">KEForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">setting</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="s1">&#39;angola&#39;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">AOForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">setting</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">MZForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">setting</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">duesetting</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">owner_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">duesetting</span><span class="o">.</span><span class="n">invoice_overdue_period</span>
                <span class="k">if</span> <span class="n">duration</span> <span class="o">!=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;invoice_overdue_period&#39;</span><span class="p">]:</span>
                    <span class="n">time_threshold</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;invoice_overdue_period&#39;</span><span class="p">])</span>
                    <span class="n">due_list</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">created_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                                              <span class="n">invoice_date__lt</span><span class="o">=</span><span class="n">time_threshold</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">due</span> <span class="ow">in</span> <span class="n">due_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">due</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;unpaid&#39;</span><span class="p">:</span>
                            <span class="n">due</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;overdue&#39;</span>
                            <span class="n">due</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="n">change_due_list</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">created_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                                                     <span class="n">invoice_date__gt</span><span class="o">=</span><span class="n">time_threshold</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">due</span> <span class="ow">in</span> <span class="n">change_due_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">due</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;overdue&#39;</span><span class="p">:</span>
                            <span class="n">due</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;unpaid&#39;</span>
                            <span class="n">due</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">u_message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Setup Your Invoice Overdue Period&#39;</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">u_message</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="n">setting</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">setting</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;settings-detail&#39;</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="SettingsUpdateView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.SettingsUpdateView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">setting</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Settings</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">setting</span><span class="o">.</span><span class="n">owner_settings</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="MPesaUpdateView"><a class="viewcode-back" href="../../sales.html#sales.views.MPesaUpdateView">[docs]</a><span class="k">class</span> <span class="nc">MPesaUpdateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Settings</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/mpesa_update.html&#39;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b2c_api_key&#39;</span><span class="p">,</span> <span class="s1">&#39;b2c_public_key&#39;</span><span class="p">,</span> <span class="s1">&#39;b2c_service_provider_code&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="MPesaUpdateView.form_valid"><a class="viewcode-back" href="../../sales.html#sales.views.MPesaUpdateView.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">owner_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span></div>

<div class="viewcode-block" id="MPesaUpdateView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.MPesaUpdateView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">owner_settings</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="s1">&#39;mozambique&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="LipaNaMpesaUpdateView"><a class="viewcode-back" href="../../sales.html#sales.views.LipaNaMpesaUpdateView">[docs]</a><span class="k">class</span> <span class="nc">LipaNaMpesaUpdateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Settings</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/mpesa_update.html&#39;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;consumer_key&#39;</span><span class="p">,</span> <span class="s1">&#39;consumer_secret&#39;</span><span class="p">,</span> <span class="s1">&#39;businessShortCode&#39;</span><span class="p">,</span> <span class="s1">&#39;lipa_na_mpesa_passkey&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="LipaNaMpesaUpdateView.form_valid"><a class="viewcode-back" href="../../sales.html#sales.views.LipaNaMpesaUpdateView.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">owner_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span></div>

<div class="viewcode-block" id="LipaNaMpesaUpdateView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.LipaNaMpesaUpdateView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">owner_settings</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="s1">&#39;kenya&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<span class="c1">################             New Invoicing process            ######################################</span>


<div class="viewcode-block" id="NewInvoiceTotal"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceTotal">[docs]</a><span class="k">class</span> <span class="nc">NewInvoiceTotal</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">View</span><span class="p">):</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/invoice_new_product.html&#39;</span>

<div class="viewcode-block" id="NewInvoiceTotal.get"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceTotal.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">invoice_obj</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">InvoiceNewTotal</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">invoice_obj</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ProductForm</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">company</span> <span class="o">=</span> <span class="n">CompProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>

        <span class="n">i_list</span> <span class="o">=</span> <span class="n">InvoiceNew</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">invoices</span><span class="o">=</span><span class="n">invoice_obj</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;company_choice&quot;</span><span class="p">:</span> <span class="n">company</span><span class="o">.</span><span class="n">company_name</span><span class="p">,</span> <span class="s1">&#39;i_list&#39;</span><span class="p">:</span> <span class="n">i_list</span><span class="p">,</span> <span class="s1">&#39;invoice_obj&#39;</span><span class="p">:</span> <span class="n">invoice_obj</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="NewInvoiceTotal.post"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceTotal.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">invoice_obj</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">InvoiceNewTotal</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">invoice_obj</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ProductForm</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;send&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">devices.views</span> <span class="k">import</span> <span class="n">send_invoice_fcm</span>
            <span class="n">send_invoice_fcm</span><span class="p">(</span><span class="n">invoice_obj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;newinvoices-detail&#39;</span><span class="p">,</span> <span class="n">invoice_obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;product&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]:</span>
                <span class="n">i_list</span> <span class="o">=</span> <span class="n">InvoiceNew</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">invoices</span><span class="o">=</span><span class="n">invoice_obj</span><span class="p">)</span>
                <span class="n">company</span> <span class="o">=</span> <span class="n">CompProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">ProductForm</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Please fill in all required information&#39;</span><span class="p">))</span>
                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;company_choice&quot;</span><span class="p">:</span> <span class="n">company</span><span class="p">,</span> <span class="s1">&#39;i_list&#39;</span><span class="p">:</span> <span class="n">i_list</span><span class="p">,</span> <span class="s1">&#39;invoice_obj&#39;</span><span class="p">:</span> <span class="n">invoice_obj</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

            <span class="n">pricing_obj</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;product&#39;</span><span class="p">]</span>
            <span class="n">quantity</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">invoices</span> <span class="o">=</span> <span class="n">invoice_obj</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">pricing_obj</span><span class="o">.</span><span class="n">product_price</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">tax_exemption</span> <span class="o">=</span> <span class="n">pricing_obj</span><span class="o">.</span><span class="n">tax_exemption</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">exemption</span> <span class="o">=</span> <span class="n">pricing_obj</span><span class="o">.</span><span class="n">exemption</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">pricing_obj</span><span class="o">.</span><span class="n">product_name</span>

            <span class="n">uservat</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="n">calcvat</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">owner_settings</span><span class="o">=</span><span class="n">uservat</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pricing_obj</span><span class="o">.</span><span class="n">tax_exemption</span><span class="p">:</span>
                <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">tax</span> <span class="o">=</span> <span class="p">(</span><span class="n">calcvat</span><span class="o">.</span><span class="n">vat</span> <span class="o">*</span> <span class="n">pricing_obj</span><span class="o">.</span><span class="n">product_price</span> <span class="o">*</span> <span class="n">quantity</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">tax</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">supplier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span>
            <span class="n">invoicedetail</span> <span class="o">=</span> <span class="n">InvoiceNew</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">invoices</span><span class="o">=</span><span class="n">invoice_obj</span><span class="p">)</span>    <span class="c1">#loop thru all invoices</span>

            <span class="n">newtotal</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">newvattotal</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">tot</span> <span class="ow">in</span> <span class="n">invoicedetail</span><span class="p">:</span>
                <span class="n">newtotal</span> <span class="o">=</span> <span class="n">newtotal</span> <span class="o">+</span> <span class="n">tot</span><span class="o">.</span><span class="n">item_total</span><span class="p">()</span>
                <span class="n">newvattotal</span> <span class="o">=</span> <span class="n">newvattotal</span> <span class="o">+</span> <span class="n">tot</span><span class="o">.</span><span class="n">tax</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">sub_total</span> <span class="o">=</span> <span class="n">newtotal</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">vat</span> <span class="o">=</span> <span class="n">newvattotal</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">vat_rate</span> <span class="o">=</span> <span class="n">calcvat</span><span class="o">.</span><span class="n">vat</span>

            <span class="c1"># calc total price</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="p">(</span><span class="n">invoice_obj</span><span class="o">.</span><span class="n">sub_total</span> <span class="o">+</span> <span class="n">invoice_obj</span><span class="o">.</span><span class="n">vat</span><span class="p">)</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">i_list</span> <span class="o">=</span> <span class="n">InvoiceNew</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">invoices</span><span class="o">=</span><span class="n">invoice_obj</span><span class="p">)</span>

        <span class="n">company</span> <span class="o">=</span> <span class="n">CompProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ProductForm</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;company_choice&quot;</span><span class="p">:</span> <span class="n">company</span><span class="p">,</span> <span class="s1">&#39;i_list&#39;</span><span class="p">:</span> <span class="n">i_list</span><span class="p">,</span> <span class="s1">&#39;invoice_obj&#39;</span><span class="p">:</span> <span class="n">invoice_obj</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="NewInvoiceTotal.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceTotal.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="n">invoicenewtotal</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">InvoiceNewTotal</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pk&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">invoicenewtotal</span><span class="o">.</span><span class="n">created_by</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">invoicenewtotal</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;unpaid&#39;</span> <span class="ow">or</span> <span class="n">invoicenewtotal</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;overdue&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="NewInvoiceTotalCustom"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceTotalCustom">[docs]</a><span class="k">class</span> <span class="nc">NewInvoiceTotalCustom</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">View</span><span class="p">):</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/invoice_new_custom.html&#39;</span>

<div class="viewcode-block" id="NewInvoiceTotalCustom.get"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceTotalCustom.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">invoice_obj</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">InvoiceNewTotal</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">invoice_obj</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">country</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CustomProductForm</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">company</span> <span class="o">=</span> <span class="n">CompProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">i_list</span> <span class="o">=</span> <span class="n">InvoiceNew</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">invoices</span><span class="o">=</span><span class="n">invoice_obj</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;company_choice&quot;</span><span class="p">:</span> <span class="n">company</span><span class="o">.</span><span class="n">company_name</span><span class="p">,</span> <span class="s1">&#39;i_list&#39;</span><span class="p">:</span> <span class="n">i_list</span><span class="p">,</span> <span class="s1">&#39;invoice_obj&#39;</span><span class="p">:</span> <span class="n">invoice_obj</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="NewInvoiceTotalCustom.post"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceTotalCustom.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">invoice_obj</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">InvoiceNewTotal</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">invoice_obj</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">country</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CustomProductForm</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;send&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">devices.views</span> <span class="k">import</span> <span class="n">send_invoice_fcm</span>
            <span class="n">send_invoice_fcm</span><span class="p">(</span><span class="n">invoice_obj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;newinvoices-detail&#39;</span><span class="p">,</span> <span class="n">invoice_obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
                <span class="n">i_list</span> <span class="o">=</span> <span class="n">InvoiceNew</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">invoices</span><span class="o">=</span><span class="n">invoice_obj</span><span class="p">)</span>
                <span class="n">company</span> <span class="o">=</span> <span class="n">CompProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">CustomProductForm</span><span class="p">(</span><span class="n">country</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Please fill in all required information&#39;</span><span class="p">))</span>
                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;company_choice&quot;</span><span class="p">:</span> <span class="n">company</span><span class="p">,</span> <span class="s1">&#39;i_list&#39;</span><span class="p">:</span> <span class="n">i_list</span><span class="p">,</span> <span class="s1">&#39;invoice_obj&#39;</span><span class="p">:</span> <span class="n">invoice_obj</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">invoices</span> <span class="o">=</span> <span class="n">invoice_obj</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">tax_exemption</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;tax_exemption&#39;</span><span class="p">]</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">exemption</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;exemption&#39;</span><span class="p">]</span>

            <span class="n">uservat</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="n">calcvat</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">owner_settings</span><span class="o">=</span><span class="n">uservat</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">tax_exemption</span><span class="p">:</span>
                <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">tax</span> <span class="o">=</span> <span class="p">(</span><span class="n">calcvat</span><span class="o">.</span><span class="n">vat</span> <span class="o">*</span> <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">tax</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">supplier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span>
            <span class="n">invoicedetail</span> <span class="o">=</span> <span class="n">InvoiceNew</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">invoices</span><span class="o">=</span><span class="n">invoice_obj</span><span class="p">)</span>    <span class="c1">#loop thru all invoices</span>

            <span class="n">newtotal</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">newvattotal</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">tot</span> <span class="ow">in</span> <span class="n">invoicedetail</span><span class="p">:</span>
                <span class="n">newtotal</span> <span class="o">=</span> <span class="n">newtotal</span> <span class="o">+</span> <span class="n">tot</span><span class="o">.</span><span class="n">item_total</span><span class="p">()</span>
                <span class="n">newvattotal</span> <span class="o">=</span> <span class="n">newvattotal</span> <span class="o">+</span> <span class="n">tot</span><span class="o">.</span><span class="n">tax</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">sub_total</span> <span class="o">=</span> <span class="n">newtotal</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">vat</span> <span class="o">=</span> <span class="n">newvattotal</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">vat_rate</span> <span class="o">=</span> <span class="n">calcvat</span><span class="o">.</span><span class="n">vat</span>

            <span class="c1"># calc total price</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="p">(</span><span class="n">invoice_obj</span><span class="o">.</span><span class="n">sub_total</span> <span class="o">+</span> <span class="n">invoice_obj</span><span class="o">.</span><span class="n">vat</span><span class="p">)</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">i_list</span> <span class="o">=</span> <span class="n">InvoiceNew</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">invoices</span><span class="o">=</span><span class="n">invoice_obj</span><span class="p">)</span>

        <span class="n">company</span> <span class="o">=</span> <span class="n">CompProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CustomProductForm</span><span class="p">(</span><span class="n">country</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;company_choice&quot;</span><span class="p">:</span> <span class="n">company</span><span class="p">,</span> <span class="s1">&#39;i_list&#39;</span><span class="p">:</span> <span class="n">i_list</span><span class="p">,</span> <span class="s1">&#39;invoice_obj&#39;</span><span class="p">:</span> <span class="n">invoice_obj</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="NewInvoiceTotalCustom.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceTotalCustom.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="n">invoicenewtotal</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">InvoiceNewTotal</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pk&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">invoicenewtotal</span><span class="o">.</span><span class="n">created_by</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">invoicenewtotal</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;unpaid&#39;</span> <span class="ow">or</span> <span class="n">invoicenewtotal</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;overdue&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="NewInvoiceChoiceView"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceChoiceView">[docs]</a><span class="k">class</span> <span class="nc">NewInvoiceChoiceView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">View</span><span class="p">):</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/invoicenewtotal_form.html&#39;</span>

<div class="viewcode-block" id="NewInvoiceChoiceView.get"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceChoiceView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CompanyForm</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="NewInvoiceChoiceView.post"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceChoiceView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CompanyForm</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;invoice-choice&#39;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;approved&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="NewInvoiceChoiceView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceChoiceView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="InvoiceChoiceView"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceChoiceView">[docs]</a><span class="k">class</span> <span class="nc">InvoiceChoiceView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">View</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/company_choice.html&#39;</span>

<div class="viewcode-block" id="InvoiceChoiceView.get"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceChoiceView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">comp_obj</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">CompProfile</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CompanyChoiceForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;company&quot;</span><span class="p">:</span> <span class="n">comp_obj</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="InvoiceChoiceView.post"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceChoiceView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">CompanyChoiceForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="n">comp_obj</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">CompProfile</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">supplier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;unpaid&#39;</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">company</span> <span class="o">=</span> <span class="n">comp_obj</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">invoice_type</span> <span class="o">==</span> <span class="s1">&#39;standard&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;newinvoicetotal-detail&#39;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;newinvoicetotal-custom&#39;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>

<div class="viewcode-block" id="InvoiceChoiceView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.InvoiceChoiceView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">settings</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="n">profile</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Profile</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">profile</span><span class="o">.</span><span class="n">approved</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="NewInvoiceDetailView"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceDetailView">[docs]</a><span class="k">class</span> <span class="nc">NewInvoiceDetailView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">):</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span>

<div class="viewcode-block" id="NewInvoiceDetailView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceDetailView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;payment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Payments</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">invoice</span><span class="o">=</span><span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="NewInvoiceDetailView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceDetailView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">invoicenewtotal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">invoicenewtotal</span><span class="o">.</span><span class="n">created_by</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="NewInvoiceUpdateView"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceUpdateView">[docs]</a><span class="k">class</span> <span class="nc">NewInvoiceUpdateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">UpdateView</span><span class="p">):</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="p">]</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/invoicenewtotal_update.html&#39;</span>

<div class="viewcode-block" id="NewInvoiceUpdateView.form_valid"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceUpdateView.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">payinvoice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
        <span class="kn">from</span> <span class="nn">sales.send_messages</span> <span class="k">import</span> <span class="n">send_invoice_messages</span>
        <span class="n">send_invoice_messages</span><span class="p">(</span><span class="n">payinvoice</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">devices.views</span> <span class="k">import</span> <span class="n">send_invoice_fcm</span>
        <span class="n">send_invoice_fcm</span><span class="p">(</span><span class="n">payinvoice</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span></div>

<div class="viewcode-block" id="NewInvoiceUpdateView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceUpdateView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">invoicenewtotal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">invoicenewtotal</span><span class="o">.</span><span class="n">created_by</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="NewInvoiceUpdate"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceUpdate">[docs]</a><span class="k">class</span> <span class="nc">NewInvoiceUpdate</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">InvoiceNew</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="p">]</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/invoice_new_product_update.html&#39;</span>

<div class="viewcode-block" id="NewInvoiceUpdate.form_valid"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceUpdate.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">uservat</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">calcvat</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">owner_settings</span><span class="o">=</span><span class="n">uservat</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">tax_exemption</span><span class="p">:</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">tax</span> <span class="o">=</span> <span class="p">(</span><span class="n">calcvat</span><span class="o">.</span><span class="n">vat</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">price</span><span class="p">)</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">quantity</span><span class="p">))</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">tax</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">invoicedetail</span> <span class="o">=</span> <span class="n">InvoiceNew</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">invoices</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">invoices</span><span class="p">)</span>  <span class="c1"># loop thru all invoices</span>
        <span class="n">invoice_obj</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">invoices</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="n">newtotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">newvattotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">tot</span> <span class="ow">in</span> <span class="n">invoicedetail</span><span class="p">:</span>
            <span class="n">newtotal</span> <span class="o">=</span> <span class="n">newtotal</span> <span class="o">+</span> <span class="n">tot</span><span class="o">.</span><span class="n">item_total</span><span class="p">()</span>
            <span class="n">newvattotal</span> <span class="o">=</span> <span class="n">newvattotal</span> <span class="o">+</span> <span class="n">tot</span><span class="o">.</span><span class="n">tax</span>
        <span class="n">invoice_obj</span><span class="o">.</span><span class="n">sub_total</span> <span class="o">=</span> <span class="n">newtotal</span>
        <span class="n">invoice_obj</span><span class="o">.</span><span class="n">vat</span> <span class="o">=</span> <span class="n">newvattotal</span>
        <span class="n">invoice_obj</span><span class="o">.</span><span class="n">vat_rate</span> <span class="o">=</span> <span class="n">calcvat</span><span class="o">.</span><span class="n">vat</span>

        <span class="c1"># calc total price</span>
        <span class="n">invoice_obj</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="p">(</span><span class="n">invoice_obj</span><span class="o">.</span><span class="n">sub_total</span> <span class="o">+</span> <span class="n">invoice_obj</span><span class="o">.</span><span class="n">vat</span><span class="p">)</span>
        <span class="n">invoice_obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span></div>

<div class="viewcode-block" id="NewInvoiceUpdate.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceUpdate.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">invoicenew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">activate</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">invoicenew</span><span class="o">.</span><span class="n">invoices</span><span class="o">.</span><span class="n">created_by</span> <span class="ow">and</span> <span class="p">(</span><span class="n">invoicenew</span><span class="o">.</span><span class="n">invoices</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;unpaid&#39;</span> <span class="ow">or</span> <span class="n">invoicenew</span><span class="o">.</span><span class="n">invoices</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;overdue&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="NewInvoiceCustomUpdate"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceCustomUpdate">[docs]</a><span class="k">class</span> <span class="nc">NewInvoiceCustomUpdate</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">View</span><span class="p">):</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/invoice_new_custom_update.html&#39;</span>

<div class="viewcode-block" id="NewInvoiceCustomUpdate.get"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceCustomUpdate.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">country</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span>
        <span class="n">invoice</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">InvoiceNew</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CustomProductForm</span><span class="p">(</span><span class="n">country</span><span class="o">=</span><span class="n">country</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">invoice</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="NewInvoiceCustomUpdate.post"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceCustomUpdate.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">country</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">country</span>
        <span class="n">invoice</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">InvoiceNew</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CustomProductForm</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">invoice</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">invoice</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">calcvat</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">owner_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">tax_exemption</span><span class="p">:</span>
                <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">tax</span> <span class="o">=</span> <span class="p">(</span><span class="n">calcvat</span><span class="o">.</span><span class="n">vat</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">price</span><span class="p">)</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">quantity</span><span class="p">))</span> <span class="o">//</span> <span class="mi">100</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">tax</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">invoice</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">invoicedetail</span> <span class="o">=</span> <span class="n">InvoiceNew</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">invoices</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">invoices</span><span class="p">)</span>  <span class="c1"># loop thru all invoices</span>
            <span class="n">invoice_obj</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">InvoiceNewTotal</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">invoices</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

            <span class="n">newtotal</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">newvattotal</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">tot</span> <span class="ow">in</span> <span class="n">invoicedetail</span><span class="p">:</span>
                <span class="n">newtotal</span> <span class="o">=</span> <span class="n">newtotal</span> <span class="o">+</span> <span class="n">tot</span><span class="o">.</span><span class="n">item_total</span><span class="p">()</span>
                <span class="n">newvattotal</span> <span class="o">=</span> <span class="n">newvattotal</span> <span class="o">+</span> <span class="n">tot</span><span class="o">.</span><span class="n">tax</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">sub_total</span> <span class="o">=</span> <span class="n">newtotal</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">vat</span> <span class="o">=</span> <span class="n">newvattotal</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">vat_rate</span> <span class="o">=</span> <span class="n">calcvat</span><span class="o">.</span><span class="n">vat</span>

            <span class="c1"># calc total price</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="p">(</span><span class="n">invoice_obj</span><span class="o">.</span><span class="n">sub_total</span> <span class="o">+</span> <span class="n">invoice_obj</span><span class="o">.</span><span class="n">vat</span><span class="p">)</span>
            <span class="n">invoice_obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;newinvoicetotal-custom&#39;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">invoice</span><span class="o">.</span><span class="n">invoices</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span></div>

<div class="viewcode-block" id="NewInvoiceCustomUpdate.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceCustomUpdate.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">invoicenew</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">InvoiceNew</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">activate</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">invoicenew</span><span class="o">.</span><span class="n">invoices</span><span class="o">.</span><span class="n">created_by</span> <span class="ow">and</span> <span class="p">(</span><span class="n">invoicenew</span><span class="o">.</span><span class="n">invoices</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;unpaid&#39;</span> <span class="ow">or</span> <span class="n">invoicenew</span><span class="o">.</span><span class="n">invoices</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;overdue&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="NewInvoiceDeleteView"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceDeleteView">[docs]</a><span class="k">class</span> <span class="nc">NewInvoiceDeleteView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">DeleteView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>

<div class="viewcode-block" id="NewInvoiceDeleteView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceDeleteView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">invoice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">activate</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">invoice</span><span class="o">.</span><span class="n">created_by</span> <span class="ow">and</span> <span class="p">(</span><span class="n">invoice</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;unpaid&#39;</span> <span class="ow">or</span> <span class="n">invoice</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;overdue&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="NewInvoiceListView"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceListView">[docs]</a><span class="k">class</span> <span class="nc">NewInvoiceListView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/invoice_new_list.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;ilist&#39;</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">9</span>

<div class="viewcode-block" id="NewInvoiceListView.get_queryset"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceListView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">created_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="NewInvoiceFilterListView"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceFilterListView">[docs]</a><span class="k">class</span> <span class="nc">NewInvoiceFilterListView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/invoice_new_filter.html&#39;</span>

<div class="viewcode-block" id="NewInvoiceFilterListView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.NewInvoiceFilterListView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">created_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InvoiceUserFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">queryset</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">context</span></div></div>


<div class="viewcode-block" id="PaymentsListView"><a class="viewcode-back" href="../../sales.html#sales.views.PaymentsListView">[docs]</a><span class="k">class</span> <span class="nc">PaymentsListView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">ListView</span><span class="p">):</span>

    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;plist&#39;</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/payments_list.html&#39;</span>

<div class="viewcode-block" id="PaymentsListView.get_queryset"><a class="viewcode-back" href="../../sales.html#sales.views.PaymentsListView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Payments</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Payments</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="p">)</span></div>

<div class="viewcode-block" id="PaymentsListView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.PaymentsListView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="PaymentsDetailView"><a class="viewcode-back" href="../../sales.html#sales.views.PaymentsDetailView">[docs]</a><span class="k">class</span> <span class="nc">PaymentsDetailView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Payments</span>

<div class="viewcode-block" id="PaymentsDetailView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.PaymentsDetailView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">invoice_list</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Payments</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;invoice_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">invoice_list</span><span class="o">.</span><span class="n">invoice</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="PaymentsDetailView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.PaymentsDetailView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">payments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span> <span class="o">==</span> <span class="n">payments</span><span class="o">.</span><span class="n">company</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span> <span class="o">==</span> <span class="n">payments</span><span class="o">.</span><span class="n">company</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="MyInvoicedListView"><a class="viewcode-back" href="../../sales.html#sales.views.MyInvoicedListView">[docs]</a><span class="k">class</span> <span class="nc">MyInvoicedListView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/myinvoiced_list.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;plist&#39;</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">9</span>

<div class="viewcode-block" id="MyInvoicedListView.get_queryset"><a class="viewcode-back" href="../../sales.html#sales.views.MyInvoicedListView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="p">)</span></div>

<div class="viewcode-block" id="MyInvoicedListView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.MyInvoicedListView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="MyInvoicedTotalsDetailView"><a class="viewcode-back" href="../../sales.html#sales.views.MyInvoicedTotalsDetailView">[docs]</a><span class="k">class</span> <span class="nc">MyInvoicedTotalsDetailView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/myinvoiced_detail.html&#39;</span>

<div class="viewcode-block" id="MyInvoicedTotalsDetailView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.MyInvoicedTotalsDetailView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;payment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Payments</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">invoice</span><span class="o">=</span><span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="MyInvoicedTotalsDetailView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.MyInvoicedTotalsDetailView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">invoice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span> <span class="o">==</span> <span class="n">invoice</span><span class="o">.</span><span class="n">company</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span> <span class="o">==</span> <span class="n">invoice</span><span class="o">.</span><span class="n">company</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="ConfirmPasswordView"><a class="viewcode-back" href="../../sales.html#sales.views.ConfirmPasswordView">[docs]</a><span class="k">class</span> <span class="nc">ConfirmPasswordView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">ConfirmPasswordForm</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/confirm_password.html&#39;</span>

<div class="viewcode-block" id="ConfirmPasswordView.get_object"><a class="viewcode-back" href="../../sales.html#sales.views.ConfirmPasswordView.get_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span></div>

<div class="viewcode-block" id="ConfirmPasswordView.get_success_url"><a class="viewcode-back" href="../../sales.html#sales.views.ConfirmPasswordView.get_success_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get_full_path</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="PaymentsCreateView"><a class="viewcode-back" href="../../sales.html#sales.views.PaymentsCreateView">[docs]</a><span class="k">class</span> <span class="nc">PaymentsCreateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">CreateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Payments</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">PaymentForm</span>

<div class="viewcode-block" id="PaymentsCreateView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.PaymentsCreateView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="PaymentsCreateView.form_valid"><a class="viewcode-back" href="../../sales.html#sales.views.PaymentsCreateView.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">:</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span>

        <span class="n">invoice</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
        <span class="n">payinvoice</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">invoice</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>  <span class="c1">#changes status to paid</span>
        <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">seller</span> <span class="o">=</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">created_by</span><span class="o">.</span><span class="n">profile</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;payment_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mpesa&#39;</span><span class="p">:</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">transaction_id</span> <span class="o">=</span> <span class="s1">&#39;processing&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">b2c_api_key</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Setup your MPesa Business to Customer settings: &#39;</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;myinvoiced-create&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Setup your MPesa Business to Customer settings: &#39;</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;myinvoiced-create&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
        <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">pay_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">invoice</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">payinvoice</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">total</span> <span class="o">==</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;payment_value&#39;</span><span class="p">]:</span>
            <span class="n">payinvoice</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;paid&#39;</span>
        <span class="k">elif</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">total</span> <span class="o">&gt;</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;payment_value&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">payinvoice</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;partial&#39;</span>
                <span class="n">payinvoice</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">total</span> <span class="o">-</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;payment_value&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">payinvoice</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">balance</span> <span class="o">-</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;payment_value&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">payinvoice</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;paid&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">payinvoice</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;partial&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">payinvoice</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;overpaid&#39;</span>

        <span class="k">elif</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">total</span> <span class="o">&lt;</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;payment_value&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">payinvoice</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;overpaid&#39;</span>
                <span class="n">payinvoice</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">total</span> <span class="o">-</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;payment_value&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">payinvoice</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">balance</span> <span class="o">-</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;payment_value&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">payinvoice</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;paid&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">payinvoice</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;partial&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">payinvoice</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;overpaid&#39;</span>

        <span class="n">payinvoice</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;payment_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mpesa&#39;</span><span class="p">:</span>
            <span class="n">paytype</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Mobile Money&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;payment_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bank_deposit&#39;</span><span class="p">:</span>
            <span class="n">paytype</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Bank Deposit&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;payment_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cash&#39;</span><span class="p">:</span>
            <span class="n">paytype</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Cash&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;payment_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cheque&#39;</span><span class="p">:</span>
            <span class="n">paytype</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Cheque&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">paytype</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Other&#39;</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">sales.send_messages</span> <span class="k">import</span> <span class="n">send_payment_messages</span>
        <span class="n">send_payment_messages</span><span class="p">(</span><span class="n">payinvoice</span><span class="p">,</span> <span class="n">paytype</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;payment_value&#39;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;reference&#39;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">devices.views</span> <span class="k">import</span> <span class="n">send_payment_fcm</span>
        <span class="n">send_payment_fcm</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;payment_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mpesa&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">payments.samples.b2c_vm</span> <span class="k">import</span> <span class="n">b2c_payment</span>
            <span class="n">b2c_response</span> <span class="o">=</span> <span class="n">b2c_payment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;payment_value&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">b2c_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">b2c_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
                <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">conversation_id</span> <span class="o">=</span> <span class="n">b2c_response</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s1">&#39;output_ConversationID&#39;</span><span class="p">]</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Mpesa transaction was successful, Message: &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">b2c_response</span><span class="o">.</span><span class="n">body</span><span class="p">[</span>
                    <span class="s1">&#39;output_ResponseDesc&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Mpesa transaction was not successful, Error: &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">b2c_response</span><span class="o">.</span><span class="n">body</span><span class="p">[</span>
                    <span class="s1">&#39;output_ResponseDesc&#39;</span><span class="p">])</span>
                <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">transaction_id</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Transaction Failed&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;myinvoiced-list&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span></div>

<div class="viewcode-block" id="PaymentsCreateView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.PaymentsCreateView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">invoicenewtotal</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span> <span class="o">==</span> <span class="n">invoicenewtotal</span><span class="o">.</span><span class="n">company</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span> <span class="o">==</span> <span class="n">invoicenewtotal</span><span class="o">.</span><span class="n">company</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="DeliveryUpdateView"><a class="viewcode-back" href="../../sales.html#sales.views.DeliveryUpdateView">[docs]</a><span class="k">class</span> <span class="nc">DeliveryUpdateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">View</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/delivery_form.html&#39;</span>

<div class="viewcode-block" id="DeliveryUpdateView.get"><a class="viewcode-back" href="../../sales.html#sales.views.DeliveryUpdateView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">invoice</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">InvoiceNewTotal</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">DeliveryForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">invoice</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s1">&#39;inv&#39;</span><span class="p">:</span> <span class="n">invoice</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="DeliveryUpdateView.post"><a class="viewcode-back" href="../../sales.html#sales.views.DeliveryUpdateView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">invoice</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">InvoiceNewTotal</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">DeliveryForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">invoice</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;myinvoiced-detail&#39;</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;invoice-delivery&#39;</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span></div>

<div class="viewcode-block" id="DeliveryUpdateView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.DeliveryUpdateView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">invoice</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">InvoiceNewTotal</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">:</span>
            <span class="n">company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span>
        <span class="k">if</span> <span class="n">company</span> <span class="o">==</span> <span class="n">invoice</span><span class="o">.</span><span class="n">company</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="SettleOverpaid"><a class="viewcode-back" href="../../sales.html#sales.views.SettleOverpaid">[docs]</a><span class="k">class</span> <span class="nc">SettleOverpaid</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">View</span><span class="p">):</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Payments</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">SettleForm</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/settle_overpaid.html&#39;</span>

<div class="viewcode-block" id="SettleOverpaid.get"><a class="viewcode-back" href="../../sales.html#sales.views.SettleOverpaid.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">invoice_id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">:</span>
            <span class="n">company_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">company_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span>

        <span class="n">seller_inv</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">InvoiceNewTotal</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">invoice_id</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SettleForm</span><span class="p">(</span><span class="n">company_inv</span><span class="p">,</span> <span class="n">seller_inv</span><span class="o">.</span><span class="n">created_by</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;seller_inv&quot;</span><span class="p">:</span> <span class="n">seller_inv</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="SettleOverpaid.post"><a class="viewcode-back" href="../../sales.html#sales.views.SettleOverpaid.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">invoice_id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">:</span>
            <span class="n">company_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">company_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span>

        <span class="n">seller_inv</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">InvoiceNewTotal</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">invoice_id</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SettleForm</span><span class="p">(</span><span class="n">company_inv</span><span class="p">,</span> <span class="n">seller_inv</span><span class="o">.</span><span class="n">created_by</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">payment</span> <span class="o">=</span> <span class="n">Payments</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">invoice</span><span class="o">=</span><span class="n">seller_inv</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="n">inv_total</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">invoice</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;Invoice&#39;</span><span class="p">]:</span>
                <span class="n">inv_total</span> <span class="o">=</span> <span class="n">inv_total</span> <span class="o">+</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total</span>
            <span class="k">if</span> <span class="n">inv_total</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">seller_inv</span><span class="o">.</span><span class="n">balance</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Error: Invoice value exceeds overpayment! Invoice amount: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">inv_total</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; Overpayment: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">seller_inv</span><span class="o">.</span><span class="n">balance</span><span class="p">)))</span>
                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;seller_inv&quot;</span><span class="p">:</span> <span class="n">seller_inv</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">payinvoice</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;Invoice&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">total</span> <span class="o">==</span> <span class="o">-</span><span class="n">seller_inv</span><span class="o">.</span><span class="n">balance</span><span class="p">:</span>
                    <span class="n">payinvoice</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;paid&#39;</span>
                    <span class="n">seller_inv</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;paid&#39;</span>
                    <span class="n">seller_inv</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">seller_inv</span><span class="o">.</span><span class="n">balance</span> <span class="o">+</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">total</span>
                    <span class="n">payment</span><span class="o">.</span><span class="n">invoice</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">payinvoice</span><span class="p">)</span>
                    <span class="n">payinvoice</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">total</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">seller_inv</span><span class="o">.</span><span class="n">balance</span><span class="p">:</span>
                        <span class="n">payinvoice</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;paid&#39;</span>
                        <span class="n">seller_inv</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">seller_inv</span><span class="o">.</span><span class="n">balance</span> <span class="o">+</span> <span class="n">payinvoice</span><span class="o">.</span><span class="n">total</span>
                        <span class="n">payment</span><span class="o">.</span><span class="n">invoice</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">payinvoice</span><span class="p">)</span>
                        <span class="n">payinvoice</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">seller_inv</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;payments-list&#39;</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;seller_inv&quot;</span><span class="p">:</span> <span class="n">seller_inv</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="SettleOverpaid.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.SettleOverpaid.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">invoicenewtotal</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;invoice_id&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span> <span class="o">==</span> <span class="n">invoicenewtotal</span><span class="o">.</span><span class="n">company</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span> <span class="o">==</span> <span class="n">invoicenewtotal</span><span class="o">.</span><span class="n">company</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="UserStatementDetailView"><a class="viewcode-back" href="../../sales.html#sales.views.UserStatementDetailView">[docs]</a><span class="k">class</span> <span class="nc">UserStatementDetailView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/user_statement_detail.html&#39;</span>

<div class="viewcode-block" id="UserStatementDetailView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.UserStatementDetailView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">created_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">_filter</span> <span class="o">=</span> <span class="n">UserStatementFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">queryset</span><span class="p">)</span>

        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_filter</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;no_invoices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_filter</span><span class="o">.</span><span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">no_paid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">no_unpaid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">no_overdue</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">no_partial</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">no_overpaid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_paid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_unpaid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_overdue</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_partial</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_overpaid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_partial_balance</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_overpaid_balance</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_filter</span><span class="o">.</span><span class="n">qs</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;paid&#39;</span><span class="p">:</span>
                <span class="n">total_paid</span> <span class="o">=</span> <span class="n">total_paid</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">total</span>
                <span class="n">no_paid</span> <span class="o">=</span> <span class="n">no_paid</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;unpaid&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">total_unpaid</span> <span class="o">=</span> <span class="n">total_unpaid</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">total</span>
                    <span class="n">no_unpaid</span> <span class="o">=</span> <span class="n">no_unpaid</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;overdue&#39;</span><span class="p">:</span>
                <span class="n">total_overdue</span> <span class="o">=</span> <span class="n">total_overdue</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">total</span>
                <span class="n">no_overdue</span> <span class="o">=</span> <span class="n">no_overdue</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;partial&#39;</span><span class="p">:</span>
                <span class="n">total_partial</span> <span class="o">=</span> <span class="n">total_partial</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">total</span>
                <span class="n">total_partial_balance</span> <span class="o">=</span> <span class="n">total_partial_balance</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">balance</span>
                <span class="n">no_partial</span> <span class="o">=</span> <span class="n">no_partial</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;overpaid&#39;</span><span class="p">:</span>
                <span class="n">total_overpaid</span> <span class="o">=</span> <span class="n">total_overpaid</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">total</span>
                <span class="n">total_overpaid_balance</span> <span class="o">=</span> <span class="n">total_overpaid_balance</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">balance</span>
                <span class="n">no_overpaid</span> <span class="o">=</span> <span class="n">no_overpaid</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;no_paid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_paid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;no_unpaid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_unpaid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;no_overdue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_overdue</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;no_partial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_partial</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;no_overpaid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_overpaid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_paid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_paid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_unpaid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_unpaid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_overdue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_overdue</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_partial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_partial</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_overpaid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_overpaid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_partial_balance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_partial_balance</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_overpaid_balance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">total_overpaid_balance</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_balance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_partial_balance</span> <span class="o">+</span> <span class="n">total_overpaid_balance</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_payment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_paid</span> <span class="o">+</span> <span class="n">total_overpaid</span> <span class="o">+</span> <span class="n">total_partial</span> <span class="o">-</span> <span class="n">total_partial_balance</span> <span class="o">-</span> <span class="n">total_overpaid_balance</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_unpaid</span> <span class="o">+</span> <span class="n">total_overdue</span> <span class="o">+</span> <span class="n">total_partial_balance</span> <span class="o">+</span> <span class="n">total_overpaid_balance</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_filter</span><span class="o">.</span><span class="n">qs</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total__sum&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="UserStatementDetailView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.UserStatementDetailView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="CompanyStatementDetailView"><a class="viewcode-back" href="../../sales.html#sales.views.CompanyStatementDetailView">[docs]</a><span class="k">class</span> <span class="nc">CompanyStatementDetailView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/company_statement_detail.html&#39;</span>

<div class="viewcode-block" id="CompanyStatementDetailView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.CompanyStatementDetailView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">)</span>
            <span class="n">_filter</span> <span class="o">=</span> <span class="n">CompanyStatementFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">queryset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="p">)</span>
            <span class="n">_filter</span> <span class="o">=</span> <span class="n">CompanyStatementFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">queryset</span><span class="p">)</span>

        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_filter</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;no_invoices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_filter</span><span class="o">.</span><span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">no_paid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">no_unpaid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">no_overdue</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">no_overpaid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_paid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_unpaid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_overpaid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_overdue</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_filter</span><span class="o">.</span><span class="n">qs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;paid&#39;</span><span class="p">:</span>
                <span class="n">total_paid</span> <span class="o">=</span> <span class="n">total_paid</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">total</span>
                <span class="n">no_paid</span> <span class="o">=</span> <span class="n">no_paid</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;unpaid&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">total_unpaid</span> <span class="o">=</span> <span class="n">total_unpaid</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">total</span>
                    <span class="n">no_unpaid</span> <span class="o">=</span> <span class="n">no_unpaid</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;overdue&#39;</span><span class="p">:</span>
                <span class="n">total_overdue</span> <span class="o">=</span> <span class="n">total_overdue</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">total</span>
                <span class="n">no_overdue</span> <span class="o">=</span> <span class="n">no_overdue</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;overpaid&#39;</span><span class="p">:</span>
                <span class="n">total_overpaid</span> <span class="o">=</span> <span class="n">total_overpaid</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">total</span>
                <span class="n">no_overpaid</span> <span class="o">=</span> <span class="n">no_overpaid</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;no_paid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_paid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;no_unpaid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_unpaid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;no_overdue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_overdue</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;no_overpaid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_overpaid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_paid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_paid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_unpaid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_unpaid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_overdue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_overdue</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_overpaid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_overpaid</span>

        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">_filter</span><span class="o">.</span><span class="n">qs</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total__sum&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">tax</span> <span class="o">=</span> <span class="n">_filter</span><span class="o">.</span><span class="n">qs</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;vat&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vat__sum&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;vat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;vat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="CompanyStatementDetailView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.CompanyStatementDetailView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="ISPCDetailedView"><a class="viewcode-back" href="../../sales.html#sales.views.ISPCDetailedView">[docs]</a><span class="k">class</span> <span class="nc">ISPCDetailedView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/ispc_detailed.html&#39;</span>

<div class="viewcode-block" id="ISPCDetailedView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.ISPCDetailedView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">created_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">_filter</span> <span class="o">=</span> <span class="n">ISPCFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">queryset</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_filter</span>

        <span class="n">q1_paid</span><span class="p">,</span> <span class="n">q2_paid</span><span class="p">,</span> <span class="n">q3_paid</span><span class="p">,</span> <span class="n">q4_paid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">q1_count</span><span class="p">,</span> <span class="n">q2_count</span><span class="p">,</span> <span class="n">q3_count</span><span class="p">,</span> <span class="n">q4_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">q1_total</span><span class="p">,</span> <span class="n">q2_total</span><span class="p">,</span> <span class="n">q3_total</span><span class="p">,</span> <span class="n">q4_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">total_paid</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">months</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
            <span class="n">query_month</span> <span class="o">=</span> <span class="n">_filter</span><span class="o">.</span><span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">invoice_date__month</span><span class="o">=</span><span class="n">months</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">months</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>                                 <span class="c1"># Q1</span>
                <span class="k">for</span> <span class="n">invoice</span> <span class="ow">in</span> <span class="n">query_month</span><span class="p">:</span>
                    <span class="n">q1_count</span> <span class="o">=</span> <span class="n">q1_count</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">q1_total</span> <span class="o">=</span> <span class="n">q1_total</span> <span class="o">+</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total</span>
                    <span class="k">if</span> <span class="n">invoice</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;paid&#39;</span><span class="p">:</span>
                        <span class="n">q1_paid</span> <span class="o">=</span> <span class="n">q1_paid</span> <span class="o">+</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total</span>
                        <span class="n">total_paid</span> <span class="o">=</span> <span class="n">total_paid</span> <span class="o">+</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total</span>

            <span class="k">elif</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">months</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>                             <span class="c1"># Q2</span>
                <span class="k">for</span> <span class="n">invoice</span> <span class="ow">in</span> <span class="n">query_month</span><span class="p">:</span>
                    <span class="n">q2_count</span> <span class="o">=</span> <span class="n">q2_count</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">q2_total</span> <span class="o">=</span> <span class="n">q2_total</span> <span class="o">+</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total</span>
                    <span class="k">if</span> <span class="n">invoice</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;paid&#39;</span><span class="p">:</span>
                        <span class="n">q2_paid</span> <span class="o">=</span> <span class="n">q2_paid</span> <span class="o">+</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total</span>
                        <span class="n">total_paid</span> <span class="o">=</span> <span class="n">total_paid</span> <span class="o">+</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total</span>

            <span class="k">elif</span> <span class="mi">5</span> <span class="o">&lt;</span> <span class="n">months</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>                              <span class="c1"># Q3</span>
                <span class="k">for</span> <span class="n">invoice</span> <span class="ow">in</span> <span class="n">query_month</span><span class="p">:</span>
                    <span class="n">q3_count</span> <span class="o">=</span> <span class="n">q3_count</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">q3_total</span> <span class="o">=</span> <span class="n">q3_total</span> <span class="o">+</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total</span>
                    <span class="k">if</span> <span class="n">invoice</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;paid&#39;</span><span class="p">:</span>
                        <span class="n">q3_paid</span> <span class="o">=</span> <span class="n">q3_paid</span> <span class="o">+</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total</span>
                        <span class="n">total_paid</span> <span class="o">=</span> <span class="n">total_paid</span> <span class="o">+</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total</span>

            <span class="k">elif</span> <span class="mi">8</span> <span class="o">&lt;</span> <span class="n">months</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>                             <span class="c1"># Q4</span>
                <span class="k">for</span> <span class="n">invoice</span> <span class="ow">in</span> <span class="n">query_month</span><span class="p">:</span>
                    <span class="n">q4_count</span> <span class="o">=</span> <span class="n">q4_count</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">q4_total</span> <span class="o">=</span> <span class="n">q4_total</span> <span class="o">+</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total</span>
                    <span class="k">if</span> <span class="n">invoice</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;paid&#39;</span><span class="p">:</span>
                        <span class="n">q4_paid</span> <span class="o">=</span> <span class="n">q4_paid</span> <span class="o">+</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total</span>
                        <span class="n">total_paid</span> <span class="o">=</span> <span class="n">total_paid</span> <span class="o">+</span> <span class="n">invoice</span><span class="o">.</span><span class="n">total</span>

        <span class="n">setting</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">owner_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;ispc_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">setting</span><span class="o">.</span><span class="n">ispc</span>

        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q1_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q1_total</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q1_paid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q1_paid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q1_ispc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q1_paid</span> <span class="o">*</span> <span class="n">setting</span><span class="o">.</span><span class="n">ispc</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q1_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q1_count</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q2_paid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q2_paid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q2_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q2_total</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q2_ispc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q2_paid</span> <span class="o">*</span> <span class="n">setting</span><span class="o">.</span><span class="n">ispc</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q2_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q2_count</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q3_paid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q3_paid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q3_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q3_total</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q3_ispc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q3_paid</span> <span class="o">*</span> <span class="n">setting</span><span class="o">.</span><span class="n">ispc</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q3_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q3_count</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q4_paid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q4_paid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q4_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q4_total</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q4_ispc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q4_paid</span> <span class="o">*</span> <span class="n">setting</span><span class="o">.</span><span class="n">ispc</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;q4_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q4_count</span>

        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;no_invoices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_filter</span><span class="o">.</span><span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_paid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_paid</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_filter</span><span class="o">.</span><span class="n">qs</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total__sum&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_paid&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;ispc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">setting</span><span class="o">.</span><span class="n">ispc</span> <span class="o">*</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;total_paid&#39;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;ispc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="ISPCDetailedView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.ISPCDetailedView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">user</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="MyInvoicedFilterView"><a class="viewcode-back" href="../../sales.html#sales.views.MyInvoicedFilterView">[docs]</a><span class="k">class</span> <span class="nc">MyInvoicedFilterView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">ListView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/myinvoiced_filter.html&#39;</span>

<div class="viewcode-block" id="MyInvoicedFilterView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.MyInvoicedFilterView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">)</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InvoiceCompanyFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="p">,</span>
                                                     <span class="n">queryset</span><span class="o">=</span><span class="n">queryset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">InvoiceNewTotal</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="p">)</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InvoiceCompanyFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="p">,</span>
                                                     <span class="n">queryset</span><span class="o">=</span><span class="n">queryset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="MyInvoicedFilterView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.MyInvoicedFilterView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="ReceiptsListView"><a class="viewcode-back" href="../../sales.html#sales.views.ReceiptsListView">[docs]</a><span class="k">class</span> <span class="nc">ReceiptsListView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>

<div class="viewcode-block" id="ReceiptsListView.get_queryset"><a class="viewcode-back" href="../../sales.html#sales.views.ReceiptsListView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Payments</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">seller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span></div>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/receipts_list.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;plist&#39;</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">10</span></div>


<div class="viewcode-block" id="ReceiptsDetailView"><a class="viewcode-back" href="../../sales.html#sales.views.ReceiptsDetailView">[docs]</a><span class="k">class</span> <span class="nc">ReceiptsDetailView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Payments</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/receipts_detail.html&#39;</span>

<div class="viewcode-block" id="ReceiptsDetailView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.ReceiptsDetailView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">invoice_list</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Payments</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;invoice_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">invoice_list</span><span class="o">.</span><span class="n">invoice</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="ReceiptsDetailView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.ReceiptsDetailView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">payment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span> <span class="o">==</span> <span class="n">payment</span><span class="o">.</span><span class="n">seller</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="InssRecordsCreateView"><a class="viewcode-back" href="../../sales.html#sales.views.InssRecordsCreateView">[docs]</a><span class="k">class</span> <span class="nc">InssRecordsCreateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">View</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">InssRecords</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">InssForm</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/inssrecords_form.html&#39;</span>

<div class="viewcode-block" id="InssRecordsCreateView.get"><a class="viewcode-back" href="../../sales.html#sales.views.InssRecordsCreateView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">insslist</span> <span class="o">=</span> <span class="n">InssRecords</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InssForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">total_salary</span> <span class="o">=</span> <span class="n">insslist</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;salary&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;salary__sum&#39;</span><span class="p">)</span>
        <span class="n">inssrate</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">owner_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_salary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">total_to_pay</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_salary</span> <span class="o">*</span> <span class="n">inssrate</span><span class="o">.</span><span class="n">inss</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total_to_pay</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">number_beneficiaries</span> <span class="o">=</span> <span class="n">insslist</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;insslist&quot;</span><span class="p">:</span> <span class="n">insslist</span><span class="p">,</span> <span class="s2">&quot;total_salary&quot;</span><span class="p">:</span> <span class="n">total_salary</span><span class="p">,</span> <span class="s2">&quot;total_to_pay&quot;</span><span class="p">:</span> <span class="n">total_to_pay</span><span class="p">,</span>
                   <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">day</span><span class="p">,</span> <span class="s2">&quot;number_beneficiaries&quot;</span><span class="p">:</span> <span class="n">number_beneficiaries</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="InssRecordsCreateView.post"><a class="viewcode-back" href="../../sales.html#sales.views.InssRecordsCreateView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">insslist</span> <span class="o">=</span> <span class="n">InssRecords</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InssForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">total_salary</span> <span class="o">=</span> <span class="n">insslist</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;salary&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;salary__sum&#39;</span><span class="p">)</span>
        <span class="n">inssrate</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">owner_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_salary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">total_to_pay</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_salary</span> <span class="o">*</span> <span class="n">inssrate</span><span class="o">.</span><span class="n">inss</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total_to_pay</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">number_beneficiaries</span> <span class="o">=</span> <span class="n">insslist</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">InssForm</span><span class="p">()</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s1">&#39;insslist&#39;</span><span class="p">:</span> <span class="n">insslist</span><span class="p">,</span> <span class="s2">&quot;total_salary&quot;</span><span class="p">:</span> <span class="n">total_salary</span><span class="p">,</span> <span class="s2">&quot;total_to_pay&quot;</span><span class="p">:</span> <span class="n">total_to_pay</span><span class="p">,</span>
                   <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">day</span><span class="p">,</span> <span class="s2">&quot;number_beneficiaries&quot;</span><span class="p">:</span> <span class="n">number_beneficiaries</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="InssRecordsCreateView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.InssRecordsCreateView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="InssRecordsDeleteView"><a class="viewcode-back" href="../../sales.html#sales.views.InssRecordsDeleteView">[docs]</a><span class="k">class</span> <span class="nc">InssRecordsDeleteView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">DeleteView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">InssRecords</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>

<div class="viewcode-block" id="InssRecordsDeleteView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.InssRecordsDeleteView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">inss</span><span class="o">.</span><span class="n">user</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="InssRecordsUpdateView"><a class="viewcode-back" href="../../sales.html#sales.views.InssRecordsUpdateView">[docs]</a><span class="k">class</span> <span class="nc">InssRecordsUpdateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">InssRecords</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">InssForm</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/inssrecords_update.html&#39;</span>

<div class="viewcode-block" id="InssRecordsUpdateView.form_valid"><a class="viewcode-back" href="../../sales.html#sales.views.InssRecordsUpdateView.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span></div>

<div class="viewcode-block" id="InssRecordsUpdateView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.InssRecordsUpdateView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">inss</span><span class="o">.</span><span class="n">user</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="InssCompanyRecordsCreateView"><a class="viewcode-back" href="../../sales.html#sales.views.InssCompanyRecordsCreateView">[docs]</a><span class="k">class</span> <span class="nc">InssCompanyRecordsCreateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">View</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">InssCompanyRecords</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">InssForm</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/inssrecords_company_form.html&#39;</span>

<div class="viewcode-block" id="InssCompanyRecordsCreateView.get"><a class="viewcode-back" href="../../sales.html#sales.views.InssCompanyRecordsCreateView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">insslist</span> <span class="o">=</span> <span class="n">InssCompanyRecords</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InssCompanyForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">total_salary</span> <span class="o">=</span> <span class="n">insslist</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;salary&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;salary__sum&#39;</span><span class="p">)</span>
        <span class="n">inssrate</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">owner_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_salary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">total_to_pay</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_salary</span> <span class="o">*</span> <span class="n">inssrate</span><span class="o">.</span><span class="n">inss</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total_to_pay</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">number_beneficiaries</span> <span class="o">=</span> <span class="n">insslist</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;insslist&quot;</span><span class="p">:</span> <span class="n">insslist</span><span class="p">,</span> <span class="s2">&quot;total_salary&quot;</span><span class="p">:</span> <span class="n">total_salary</span><span class="p">,</span> <span class="s2">&quot;total_to_pay&quot;</span><span class="p">:</span> <span class="n">total_to_pay</span><span class="p">,</span>
                   <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">day</span><span class="p">,</span> <span class="s2">&quot;number_beneficiaries&quot;</span><span class="p">:</span> <span class="n">number_beneficiaries</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="InssCompanyRecordsCreateView.post"><a class="viewcode-back" href="../../sales.html#sales.views.InssCompanyRecordsCreateView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">insslist</span> <span class="o">=</span> <span class="n">InssCompanyRecords</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InssCompanyForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">total_salary</span> <span class="o">=</span> <span class="n">insslist</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;salary&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;salary__sum&#39;</span><span class="p">)</span>
        <span class="n">inssrate</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">owner_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_salary</span><span class="p">:</span>
            <span class="n">total_to_pay</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_salary</span> <span class="o">*</span> <span class="n">inssrate</span><span class="o">.</span><span class="n">inss</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total_to_pay</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">number_beneficiaries</span> <span class="o">=</span> <span class="n">insslist</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">InssCompanyForm</span><span class="p">()</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s1">&#39;insslist&#39;</span><span class="p">:</span> <span class="n">insslist</span><span class="p">,</span> <span class="s2">&quot;total_salary&quot;</span><span class="p">:</span> <span class="n">total_salary</span><span class="p">,</span> <span class="s2">&quot;total_to_pay&quot;</span><span class="p">:</span> <span class="n">total_to_pay</span><span class="p">,</span>
                   <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">day</span><span class="p">,</span> <span class="s2">&quot;number_beneficiaries&quot;</span><span class="p">:</span> <span class="n">number_beneficiaries</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="InssCompanyRecordsCreateView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.InssCompanyRecordsCreateView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">settings</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Company Registration: Account not active&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Register a company to access this&#39;</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Setup Your Settings&#39;</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Setup Your Settings&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="InssCompanyRecordsDeleteView"><a class="viewcode-back" href="../../sales.html#sales.views.InssCompanyRecordsDeleteView">[docs]</a><span class="k">class</span> <span class="nc">InssCompanyRecordsDeleteView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">DeleteView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">InssCompanyRecords</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/inssrecords_company_confirm_delete.html&#39;</span>

<div class="viewcode-block" id="InssCompanyRecordsDeleteView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.InssCompanyRecordsDeleteView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inssrecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span> <span class="o">==</span> <span class="n">inssrecords</span><span class="o">.</span><span class="n">company</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="InssCompanyRecordsUpdateView"><a class="viewcode-back" href="../../sales.html#sales.views.InssCompanyRecordsUpdateView">[docs]</a><span class="k">class</span> <span class="nc">InssCompanyRecordsUpdateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span>  <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">InssCompanyRecords</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">InssForm</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/inssrecords_company_update.html&#39;</span>

<div class="viewcode-block" id="InssCompanyRecordsUpdateView.form_valid"><a class="viewcode-back" href="../../sales.html#sales.views.InssCompanyRecordsUpdateView.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span></div>

<div class="viewcode-block" id="InssCompanyRecordsUpdateView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.InssCompanyRecordsUpdateView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inssrecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span> <span class="o">==</span> <span class="n">inssrecords</span><span class="o">.</span><span class="n">company</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compprofile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="UserProductCreateView"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductCreateView">[docs]</a><span class="k">class</span> <span class="nc">UserProductCreateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/pricing_form.html&#39;</span>

<div class="viewcode-block" id="UserProductCreateView.get"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductCreateView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">UserProductForm</span><span class="p">()</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="UserProductCreateView.post"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductCreateView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">UserProductForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>

            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">my_products</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">geometry</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">added_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;user-product-detail&#39;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Only .jpg or .jpeg images supported&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="UserProductCreateView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductCreateView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Activate your profile&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="UserProductUpdateView"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductUpdateView">[docs]</a><span class="k">class</span> <span class="nc">UserProductUpdateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/pricing_form.html&#39;</span>

<div class="viewcode-block" id="UserProductUpdateView.get"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductUpdateView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Pricing</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">UserProductForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">product</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="UserProductUpdateView.post"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductUpdateView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Pricing</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">UserProductForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">product</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>

            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">my_products</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">geometry</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">date_updated</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">added_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;user-product-detail&#39;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Only .jpg or .jpeg images supported&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="UserProductUpdateView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductUpdateView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Pricing</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">activate</span> <span class="ow">and</span> <span class="n">product</span><span class="o">.</span><span class="n">my_products</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="UserProductDetailView"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductDetailView">[docs]</a><span class="k">class</span> <span class="nc">UserProductDetailView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Pricing</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/pricing_detail.html&#39;</span>

<div class="viewcode-block" id="UserProductDetailView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductDetailView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImageForm</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;image_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImageList</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pricing_obj</span><span class="o">=</span><span class="n">product</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SubCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pricing</span><span class="o">=</span><span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]))</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;num_ads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">my_products</span><span class="o">=</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">product</span><span class="o">.</span><span class="n">my_products</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="UserProductDetailView.post"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductDetailView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ImageForm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
        <span class="n">pricing_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">total_images</span> <span class="o">=</span> <span class="n">ImageList</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pricing_obj</span><span class="o">=</span><span class="n">pricing_obj</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">total_images</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Maximum 5 extra images per product&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;user-product-detail&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">pricing_obj</span><span class="o">.</span><span class="n">my_products</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.jpg&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.jpeg&#39;</span><span class="p">):</span>
                    <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">pricing_obj</span> <span class="o">=</span> <span class="n">pricing_obj</span>
                    <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;user-product-detail&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Only .jpg or .jpeg images supported&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Only .jpg or .jpeg images supported&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;user-product-detail&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="UserProductDetailView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductDetailView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pricing_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pricing_obj</span><span class="o">.</span><span class="n">my_products</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">pricing_obj</span><span class="o">.</span><span class="n">activate</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="ImageListDeleteView"><a class="viewcode-back" href="../../sales.html#sales.views.ImageListDeleteView">[docs]</a><span class="k">class</span> <span class="nc">ImageListDeleteView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">DeleteView</span><span class="p">):</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">ImageList</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/image_confirm_delete.html&#39;</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>

<div class="viewcode-block" id="ImageListDeleteView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.ImageListDeleteView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">pricing_obj</span><span class="o">.</span><span class="n">my_products</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="UserProductListView"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductListView">[docs]</a><span class="k">class</span> <span class="nc">UserProductListView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>

<div class="viewcode-block" id="UserProductListView.get_queryset"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductListView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">activate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/pricing_list.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;plist&#39;</span>

<div class="viewcode-block" id="UserProductListView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductListView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CategoryBase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;sub_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SubCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">context</span></div></div>


<div class="viewcode-block" id="UserProductModerationListView"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductModerationListView">[docs]</a><span class="k">class</span> <span class="nc">UserProductModerationListView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>

<div class="viewcode-block" id="UserProductModerationListView.get_queryset"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductModerationListView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">activate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/pricing_moderation_list.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;plist&#39;</span></div>


<div class="viewcode-block" id="UserProductModerationUpdateView"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductModerationUpdateView">[docs]</a><span class="k">class</span> <span class="nc">UserProductModerationUpdateView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">):</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/pricing_moderation_update.html&#39;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Pricing</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;activate&#39;</span><span class="p">,</span> <span class="p">]</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="s1">&#39;/sales/product/moderation/&#39;</span>

<div class="viewcode-block" id="UserProductModerationUpdateView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductModerationUpdateView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="UserProductMyLocationListView"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductMyLocationListView">[docs]</a><span class="k">class</span> <span class="nc">UserProductMyLocationListView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>

<div class="viewcode-block" id="UserProductMyLocationListView.get_queryset"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductMyLocationListView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">location_filtered</span> <span class="o">=</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">my_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">geometry</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">my_location</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Setup your Profile&#39;</span><span class="p">))</span>
            <span class="n">my_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">distance</span>
            <span class="n">location_filtered</span> <span class="o">=</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">geometry__distance_lte</span><span class="o">=</span><span class="p">(</span><span class="n">my_location</span><span class="p">,</span> <span class="n">my_distance</span><span class="p">),</span> <span class="n">activate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Setup your Settings&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">location_filtered</span></div>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/pricing_list_location.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;plist&#39;</span>

<div class="viewcode-block" id="UserProductMyLocationListView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductMyLocationListView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CategoryBase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;sub_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SubCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">context</span></div></div>


<div class="viewcode-block" id="UserProductSubCategoryFilterView"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductSubCategoryFilterView">[docs]</a><span class="k">class</span> <span class="nc">UserProductSubCategoryFilterView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>

<div class="viewcode-block" id="UserProductSubCategoryFilterView.get_queryset"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductSubCategoryFilterView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">product_category</span><span class="o">=</span><span class="n">get_object_or_404</span><span class="p">(</span><span class="n">SubCategory</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]),</span> <span class="n">activate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/products_sub_filter.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;plist&#39;</span>

<div class="viewcode-block" id="UserProductSubCategoryFilterView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductSubCategoryFilterView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;sub_selected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">SubCategory</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CategoryBase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;sub_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SubCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">context</span></div></div>


<div class="viewcode-block" id="UserProductSubCategoryLocationFilterView"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductSubCategoryLocationFilterView">[docs]</a><span class="k">class</span> <span class="nc">UserProductSubCategoryLocationFilterView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>

<div class="viewcode-block" id="UserProductSubCategoryLocationFilterView.get_queryset"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductSubCategoryLocationFilterView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">location_filtered</span> <span class="o">=</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">my_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">geometry</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">my_location</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Setup your Profile&#39;</span><span class="p">))</span>
            <span class="n">my_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">distance</span>
            <span class="n">location_filtered</span> <span class="o">=</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">product_category</span><span class="o">=</span><span class="n">get_object_or_404</span><span class="p">(</span><span class="n">SubCategory</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]),</span> <span class="n">geometry__distance_lte</span><span class="o">=</span><span class="p">(</span><span class="n">my_location</span><span class="p">,</span> <span class="n">my_distance</span><span class="p">),</span> <span class="n">activate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                       <span class="n">user</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Setup your Settings&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">location_filtered</span></div>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/products_sub_filter_location.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;plist&#39;</span>

<div class="viewcode-block" id="UserProductSubCategoryLocationFilterView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductSubCategoryLocationFilterView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;sub_selected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">SubCategory</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CategoryBase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;sub_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SubCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">context</span></div></div>


<div class="viewcode-block" id="UserProductCategoryFilterView"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductCategoryFilterView">[docs]</a><span class="k">class</span> <span class="nc">UserProductCategoryFilterView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>

<div class="viewcode-block" id="UserProductCategoryFilterView.get_queryset"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductCategoryFilterView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">CategoryBase</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="n">subcategory</span> <span class="o">=</span> <span class="n">SubCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
        <span class="n">category_combined</span> <span class="o">=</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">subs</span> <span class="ow">in</span> <span class="n">subcategory</span><span class="p">:</span>
            <span class="n">category_list</span> <span class="o">=</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">product_category</span><span class="o">=</span><span class="n">subs</span><span class="p">,</span> <span class="n">activate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">category_combined</span> <span class="o">=</span> <span class="n">category_combined</span> <span class="o">|</span> <span class="n">category_list</span>
        <span class="k">return</span> <span class="n">category_combined</span></div>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/product_filter.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;plist&#39;</span>

<div class="viewcode-block" id="UserProductCategoryFilterView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductCategoryFilterView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;sub_selected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">CategoryBase</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CategoryBase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;sub_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SubCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">context</span></div></div>


<div class="viewcode-block" id="UserProductCategoryLocationFilterView"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductCategoryLocationFilterView">[docs]</a><span class="k">class</span> <span class="nc">UserProductCategoryLocationFilterView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>

<div class="viewcode-block" id="UserProductCategoryLocationFilterView.get_queryset"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductCategoryLocationFilterView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">CategoryBase</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="n">subcategory</span> <span class="o">=</span> <span class="n">SubCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
        <span class="n">category_combined</span> <span class="o">=</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">my_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">geometry</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">my_location</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Setup your Profile&#39;</span><span class="p">))</span>
            <span class="n">my_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">distance</span>
            <span class="k">for</span> <span class="n">subs</span> <span class="ow">in</span> <span class="n">subcategory</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">subs</span><span class="p">,</span> <span class="s1">&#39;sub&#39;</span><span class="p">)</span>
                <span class="n">category_list</span> <span class="o">=</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">geometry__distance_lte</span><span class="o">=</span><span class="p">(</span><span class="n">my_location</span><span class="p">,</span> <span class="n">my_distance</span><span class="p">),</span> <span class="n">product_category</span><span class="o">=</span><span class="n">subs</span><span class="p">,</span> <span class="n">activate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">category_list</span><span class="p">,</span> <span class="s1">&#39;category list&#39;</span><span class="p">)</span>
                <span class="n">category_combined</span> <span class="o">=</span> <span class="n">category_list</span> <span class="o">|</span> <span class="n">category_combined</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">category_combined</span><span class="p">,</span> <span class="s1">&#39;category combined&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Setup your Settings&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">category_combined</span></div>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/product_filter_location.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;plist&#39;</span>

<div class="viewcode-block" id="UserProductCategoryLocationFilterView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductCategoryLocationFilterView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;sub_selected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">CategoryBase</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CategoryBase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;sub_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SubCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">context</span></div></div>


<div class="viewcode-block" id="UserProductFilterView"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductFilterView">[docs]</a><span class="k">class</span> <span class="nc">UserProductFilterView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Pricing</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/pricing_list_filtered.html&#39;</span>

<div class="viewcode-block" id="UserProductFilterView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductFilterView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CategoryBase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;sub_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SubCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">active_products</span> <span class="o">=</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span>
                <span class="n">my_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">geometry</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">my_location</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Setup your Profile&#39;</span><span class="p">))</span>
                <span class="n">custom_distance</span> <span class="o">=</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">geometry__distance_lte</span><span class="o">=</span><span class="p">(</span><span class="n">my_location</span><span class="p">,</span> <span class="n">distance</span><span class="p">),</span> <span class="n">activate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">context</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ProductFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">custom_distance</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
                <span class="n">context</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ProductFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">active_products</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ProductFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">active_products</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">context</span></div></div>


<div class="viewcode-block" id="UserProductDeleteView"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductDeleteView">[docs]</a><span class="k">class</span> <span class="nc">UserProductDeleteView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">UserPassesTestMixin</span><span class="p">,</span> <span class="n">DeleteView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Pricing</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/pricing_confirm_delete.html&#39;</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>

<div class="viewcode-block" id="UserProductDeleteView.test_func"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductDeleteView.test_func">[docs]</a>    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pricing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">pricing</span><span class="o">.</span><span class="n">my_products</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="UserMyProductsListView"><a class="viewcode-back" href="../../sales.html#sales.views.UserMyProductsListView">[docs]</a><span class="k">class</span> <span class="nc">UserMyProductsListView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>

<div class="viewcode-block" id="UserMyProductsListView.get_queryset"><a class="viewcode-back" href="../../sales.html#sales.views.UserMyProductsListView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">my_products</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span></div>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/my_pricing_list.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;plist&#39;</span></div>


<div class="viewcode-block" id="UserProductsListView"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductsListView">[docs]</a><span class="k">class</span> <span class="nc">UserProductsListView</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>

<div class="viewcode-block" id="UserProductsListView.get_queryset"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductsListView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pricing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">my_products</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">],</span> <span class="n">activate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/user_pricing_list.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;plist&#39;</span>

<div class="viewcode-block" id="UserProductsListView.get_context_data"><a class="viewcode-back" href="../../sales.html#sales.views.UserProductsListView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;product_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Profile</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">context</span></div></div>


<div class="viewcode-block" id="ProductBuyNowView"><a class="viewcode-back" href="../../sales.html#sales.views.ProductBuyNowView">[docs]</a><span class="k">class</span> <span class="nc">ProductBuyNowView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;sales/product_buy_now.html&#39;</span>

<div class="viewcode-block" id="ProductBuyNowView.get"><a class="viewcode-back" href="../../sales.html#sales.views.ProductBuyNowView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Pricing</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">BuyNowForm</span><span class="p">()</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;product&quot;</span><span class="p">:</span> <span class="n">product</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProductBuyNowView.post"><a class="viewcode-back" href="../../sales.html#sales.views.ProductBuyNowView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Pricing</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">BuyNowForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="kn">from</span> <span class="nn">payments.samples.lipanampesa</span> <span class="k">import</span> <span class="n">lipa_na_mpesa</span>
            <span class="n">lnm_response</span> <span class="o">=</span> <span class="n">lipa_na_mpesa</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">my_products</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">lnm_response</span><span class="p">,</span> <span class="s1">&#39;response from views&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">lnm_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Request successful, enter your Mpesa PIN to complete the transaction&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;An error occured while processing your payment&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;user-product-detail&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">])</span></div></div>


</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Michael Bomett

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>